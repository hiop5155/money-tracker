openapi: 3.0.0
info:
    title: Money Tracker API
    description: Money Tracker Backend API Documentation (Node.js + Express + MongoDB)
    version: 1.4.0 # Updated to include Stock Price API
servers:
    - url: http://localhost:5000
      description: Local Development Server
    - url: https://money-tracker.xyz
      description: Production Server

components:
    securitySchemes:
        bearerAuth:
            type: http
            scheme: bearer
            bearerFormat: JWT

    schemas:
        # --- Auth Schemas ---
        RegisterRequest:
            type: object
            required:
                - email
                - password
            properties:
                email:
                    type: string
                    format: email
                    example: user@example.com
                password:
                    type: string
                    format: password
                    example: password123

        LoginRequest:
            type: object
            required:
                - email
                - password
            properties:
                email:
                    type: string
                    format: email
                    example: user@example.com
                password:
                    type: string
                    format: password
                    example: password123

        VerifyEmailRequest:
            type: object
            required:
                - email
                - code
            properties:
                email:
                    type: string
                    format: email
                code:
                    type: string
                    description: 6-digit verification code
                    example: '123456'

        ForgotPasswordRequest:
            type: object
            required:
                - email
            properties:
                email:
                    type: string
                    format: email

        VerifyResetOtpRequest:
            type: object
            required:
                - email
                - otp
            properties:
                email:
                    type: string
                    format: email
                otp:
                    type: string
                    description: OTP for password reset

        ResetPasswordRequest:
            type: object
            required:
                - email
                - otp
                - newPassword
            properties:
                email:
                    type: string
                    format: email
                otp:
                    type: string
                newPassword:
                    type: string
                    example: newPassword888

        # --- Data Schemas ---
        Expense:
            type: object
            properties:
                id:
                    type: string
                date:
                    type: string
                    format: date
                    example: '2026-01-06'
                category:
                    type: string
                    example: '午餐'
                amount:
                    type: number
                    example: 150
                note:
                    type: string
                    example: '雞腿便當'
                type: # Added type field
                    type: string
                    enum: ['expense', 'income']
                    default: 'expense'
                    example: 'expense'
                recurringId:
                    type: string
                    description: Associated Recurring Rule ID (if auto-generated)
                    nullable: true

        RecurringExpense:
            type: object
            properties:
                _id:
                    type: string
                title:
                    type: string
                    example: '房租'
                amount:
                    type: number
                    example: 15000
                category:
                    type: string
                    example: '居住'
                frequency:
                    type: string
                    enum: ['monthly', 'yearly']
                    example: 'monthly'
                startDate:
                    type: string
                    format: date
                    example: '2026-01-01'
                endDate:
                    type: string
                    format: date
                    example: '2027-01-01'
                note:
                    type: string
                    example: '銀行自動扣款'
                type: # Added type field
                    type: string
                    enum: ['expense', 'income']
                    default: 'expense'
                    example: 'expense'

        Budget:
            type: object
            properties:
                monthly:
                    type: number
                    example: 10000
                yearly:
                    type: number
                    example: 120000
                categoryLimits:
                    type: array
                    items:
                        type: object
                        properties:
                            name:
                                type: string
                                example: '午餐'
                            monthly:
                                type: number
                                example: 3000
                            yearly:
                                type: number
                                example: 36000

        StockPrice:
            type: object
            properties:
                ticker:
                    type: string
                    description: Stock ticker symbol with suffix
                    example: '0050.TW'
                price:
                    type: number
                    description: Stock price (rounded)
                    example: 181
                isEstimate:
                    type: boolean
                    description: Whether price is from fallback database
                    example: false
                source:
                    type: string
                    enum: ['yahoo_finance', 'fallback_database']
                    description: Data source
                    example: 'yahoo_finance'
                timestamp:
                    type: string
                    format: date-time
                    description: Timestamp of data retrieval
                    example: '2026-01-29T08:00:00.000Z'

# --- API Paths ---
paths:
    # ===========================
    # Authentication Endpoints
    # ===========================
    /api/auth/register:
        post:
            summary: Register new user
            tags: [Auth]
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/RegisterRequest'
            responses:
                '200':
                    description: Registration successful, verification email sent
                '400':
                    description: Email already exists or format error

    /api/auth/verify:
        post:
            summary: Verify Email (Activate account)
            tags: [Auth]
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/VerifyEmailRequest'
            responses:
                '200':
                    description: Verification successful
                '400':
                    description: Verification code incorrect

    /api/auth/login:
        post:
            summary: User Login
            tags: [Auth]
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/LoginRequest'
            responses:
                '200':
                    description: Login successful
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    token:
                                        type: string
                                        description: JWT Token
                                    email:
                                        type: string
                '403':
                    description: Account not verified

    /api/auth/forgot-password:
        post:
            summary: Forgot Password (Send OTP)
            tags: [Auth]
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/ForgotPasswordRequest'
            responses:
                '200':
                    description: OTP sent to Email

    /api/auth/verify-reset-otp:
        post:
            summary: Verify if reset password OTP is correct
            description: Used for frontend check before redirecting to "Set New Password Page"
            tags: [Auth]
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/VerifyResetOtpRequest'
            responses:
                '200':
                    description: Verification code correct
                '400':
                    description: Verification code incorrect or expired

    /api/auth/reset-password:
        post:
            summary: Set new password
            tags: [Auth]
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/ResetPasswordRequest'
            responses:
                '200':
                    description: Password reset successful

    /api/auth/delete:
        put:
            summary: Soft delete user account
            description: Sets isVerified to false, preventing future logins.
            tags: [Auth]
            security:
                - bearerAuth: []
            responses:
                '200':
                    description: Account deleted successfully
                '404':
                    description: User not found

    # ===========================
    # Data Endpoints (Protected)
    # ===========================
    /api/data:
        get:
            summary: Get all data for this user (Expenses, Categories, Budget)
            tags: [Data]
            security:
                - bearerAuth: []
            responses:
                '200':
                    description: Data retrieved successfully
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    expenses:
                                        type: array
                                        items:
                                            $ref: '#/components/schemas/Expense'
                                    categories:
                                        type: array
                                        items:
                                            type: string
                                    budget:
                                        $ref: '#/components/schemas/Budget'

    /api/expenses:
        post:
            summary: Add a new expense or income
            tags: [Data]
            security:
                - bearerAuth: []
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                date:
                                    type: string
                                category:
                                    type: string
                                amount:
                                    type: number
                                note:
                                    type: string
                                type: # Added type field
                                    type: string
                                    enum: ['expense', 'income']
                                    default: 'expense'
            responses:
                '200':
                    description: Added successfully

    /api/expenses/{id}:
        put:
            summary: Modify expense record
            tags: [Data]
            security:
                - bearerAuth: []
            parameters:
                - in: path
                  name: id
                  schema:
                      type: string
                  required: true
                  description: Expense ID
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                date: { type: string }
                                category: { type: string }
                                amount: { type: number }
                                note: { type: string }
                                type: # Added type field
                                    type: string
                                    enum: ['expense', 'income']
            responses:
                '200':
                    description: Modified successfully
        delete:
            summary: Delete expense record
            tags: [Data]
            security:
                - bearerAuth: []
            parameters:
                - in: path
                  name: id
                  schema:
                      type: string
                  required: true
            responses:
                '200':
                    description: Deleted successfully

    # ===========================
    # Import Endpoints
    # ===========================
    /api/import/csv:
        post:
            summary: Import expenses from CSV file
            tags: [Data]
            security:
                - bearerAuth: []
            requestBody:
                required: true
                content:
                    multipart/form-data:
                        schema:
                            type: object
                            properties:
                                file:
                                    type: string
                                    format: binary
                                    description: CSV file upload
            responses:
                '200':
                    description: Import successful
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    success:
                                        type: boolean
                                        example: true
                                    count:
                                        type: number
                                        example: 15
                                    message:
                                        type: string
                                        example: '成功匯入 15 筆資料'
                '400':
                    description: No file uploaded or invalid format

    # ===========================
    # Recurring Expenses Endpoints
    # ===========================
    /api/recurring:
        get:
            summary: Get all recurring expense rules
            tags: [Recurring]
            security:
                - bearerAuth: []
            responses:
                '200':
                    description: List of recurring rules
                    content:
                        application/json:
                            schema:
                                type: array
                                items:
                                    $ref: '#/components/schemas/RecurringExpense'
        post:
            summary: Create a new recurring rule (and generate expenses)
            tags: [Recurring]
            security:
                - bearerAuth: []
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            required:
                                - title
                                - amount
                                - category
                                - frequency
                                - startDate
                                - endDate
                            properties:
                                title: { type: string }
                                amount: { type: number }
                                category: { type: string }
                                frequency: { type: string, enum: ['monthly', 'yearly'] }
                                startDate: { type: string, format: date }
                                endDate: { type: string, format: date }
                                note: { type: string }
                                type: # Added type field
                                    type: string
                                    enum: ['expense', 'income']
                                    default: 'expense'
            responses:
                '200':
                    description: Created successfully
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/RecurringExpense'

    /api/recurring/{id}:
        put:
            summary: Update a recurring rule (Regenerates expenses for FUTURE dates only, preserving history)
            tags: [Recurring]
            security:
                - bearerAuth: []
            parameters:
                - in: path
                  name: id
                  schema:
                      type: string
                  required: true
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                title: { type: string }
                                amount: { type: number }
                                category: { type: string }
                                frequency: { type: string, enum: ['monthly', 'yearly'] }
                                startDate: { type: string, format: date }
                                endDate: { type: string, format: date }
                                note: { type: string }
                                type: # Added type field
                                    type: string
                                    enum: ['expense', 'income']
            responses:
                '200':
                    description: Updated successfully
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/RecurringExpense'
        delete:
            summary: Delete a recurring rule (Removes only FUTURE associated expenses, preserving history)
            tags: [Recurring]
            security:
                - bearerAuth: []
            parameters:
                - in: path
                  name: id
                  schema:
                      type: string
                  required: true
            responses:
                '200':
                    description: Deleted successfully

    # ===========================
    # Other Endpoints
    # ===========================
    /api/categories:
        post:
            summary: Add category
            tags: [Data]
            security:
                - bearerAuth: []
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                name:
                                    type: string
            responses:
                '200':
                    description: Added successfully

    /api/categories/{name}:
        delete:
            summary: Delete category
            tags: [Data]
            security:
                - bearerAuth: []
            parameters:
                - in: path
                  name: name
                  schema:
                      type: string
                  required: true
                  description: Category name (e.g., Lunch)
            responses:
                '200':
                    description: Deleted successfully

    /api/budget:
        put:
            summary: Update budget settings
            tags: [Data]
            security:
                - bearerAuth: []
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/Budget'
            responses:
                '200':
                    description: Updated successfully

    # ===========================
    # Stock Price Endpoints
    # ===========================
    /api/stocks/price/{ticker}:
        get:
            summary: Get stock price from Yahoo Finance
            description: Fetches live stock price for given ticker. Automatically handles Taiwan stock suffixes (.TW, .TWO) and US stocks.
            tags: [Stocks]
            parameters:
                - in: path
                  name: ticker
                  schema:
                      type: string
                  required: true
                  description: Stock ticker symbol (e.g., 0050, SPY, 2330)
                  example: '0050'
            responses:
                '200':
                    description: Stock price retrieved successfully
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/StockPrice'
                            examples:
                                taiwan_stock:
                                    summary: Taiwan Stock (Live)
                                    value:
                                        ticker: '0050.TW'
                                        price: 181
                                        isEstimate: false
                                        source: 'yahoo_finance'
                                        timestamp: '2026-01-29T08:00:00.000Z'
                                us_stock:
                                    summary: US Stock (Live)
                                    value:
                                        ticker: 'SPY'
                                        price: 580
                                        isEstimate: false
                                        source: 'yahoo_finance'
                                        timestamp: '2026-01-29T08:00:00.000Z'
                                fallback:
                                    summary: Fallback Database
                                    value:
                                        ticker: '0056.TW'
                                        price: 40
                                        isEstimate: true
                                        source: 'fallback_database'
                                        timestamp: '2026-01-29T08:00:00.000Z'
                '404':
                    description: Stock price not found
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    error:
                                        type: string
                                        example: 'Stock price not found'
                                    ticker:
                                        type: string
                                        example: 'UNKNOWN.TW'
                '500':
                    description: Server error
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    error:
                                        type: string
                                        example: 'Failed to fetch stock price'
                                    message:
                                        type: string
                                        example: 'Network timeout'
